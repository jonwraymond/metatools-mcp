# metatools-mcp Progressive Disclosure
# 3-phase token-efficient workflow

direction: right

vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
  actor-fill: "#e2e8f0"
  phase1-fill: "#3182ce"
  phase2-fill: "#d69e2e"
  phase3-fill: "#38a169"
}

classes: {
  container: {
    style: {
      border-radius: 12
      shadow: true
      font-size: 14
      bold: true
    }
  }
  actor: {
    style: {
      fill: ${actor-fill}
      stroke: "#a0aec0"
      stroke-width: 2
      font-color: "#1a202c"
      bold: true
    }
  }
  phase1-node: {
    style: {
      fill: ${phase1-fill}
      stroke: "#2c5282"
      stroke-width: 2
      font-color: "#fff"
    }
  }
  phase2-node: {
    style: {
      fill: ${phase2-fill}
      stroke: "#b7791f"
      stroke-width: 2
      font-color: "#fff"
    }
  }
  phase3-node: {
    style: {
      fill: ${phase3-fill}
      stroke: "#276749"
      stroke-width: 2
      font-color: "#fff"
    }
  }
  phase-flow: {
    style: {
      stroke: "#4a5568"
      stroke-width: 3
    }
  }
  data-flow: {
    style: {
      stroke: "#718096"
      stroke-width: 2
    }
  }
  skip-flow: {
    style: {
      stroke: "#a0aec0"
      stroke-width: 2
      stroke-dash: 3
    }
  }
}

# Title
title: "Progressive Disclosure Workflow" {
  shape: text
  near: top-center
  style: {
    font-size: 24
    bold: true
    font-color: "#1a365d"
  }
}

# Actor
agent: "ðŸ¤– Agent" {
  shape: person
  class: actor
}

# Phase 1: Discover
phase1: "ðŸ” Phase 1: Discover" {
  class: container
  style: {
    fill: "#ebf8ff"
    stroke: ${phase1-fill}
  }

  search_tools: "search_tools\n~50 tokens" {
    shape: step
    class: phase1-node
  }
  toolindex: "tooldiscovery/index" {
    shape: cylinder
    class: phase1-node
  }
  summary: "ðŸ“‹ Summaries\nID + Name + Tags" {
    shape: document
    class: phase1-node
  }
}

# Phase 2: Inspect
phase2: "ðŸ“– Phase 2: Inspect" {
  class: container
  style: {
    fill: "#fffff0"
    stroke: ${phase2-fill}
  }

  describe_tool: "describe_tool\n~200 tokens" {
    shape: step
    class: phase2-node
  }
  tooldocs: "tooldiscovery/tooldoc" {
    shape: document
    class: phase2-node
  }
  schema: "ðŸ“ Schemas\nInput + Output" {
    shape: page
    class: phase2-node
  }
}

# Phase 3: Execute
phase3: "â–¶ï¸ Phase 3: Execute" {
  class: container
  style: {
    fill: "#f0fff4"
    stroke: ${phase3-fill}
  }

  run_tool: "run_tool\nvariable" {
    shape: step
    class: phase3-node
  }
  toolrun: "toolexec/run" {
    shape: step
    class: phase3-node
  }
  result: "âœ… Results\nStructured Data" {
    shape: document
    class: phase3-node
  }
}

# Main flow
agent -> phase1.search_tools: "query" {
  class: data-flow
}
phase1.search_tools -> phase1.toolindex {
  class: data-flow
}
phase1.toolindex -> phase1.summary {
  class: data-flow
}

phase1.summary -> phase2.describe_tool: "tool_id" {
  class: phase-flow
}
phase2.describe_tool -> phase2.tooldocs {
  class: data-flow
}
phase2.tooldocs -> phase2.schema {
  class: data-flow
}

phase2.schema -> phase3.run_tool: "args" {
  class: phase-flow
}
phase3.run_tool -> phase3.toolrun {
  class: data-flow
}
phase3.toolrun -> phase3.result {
  class: data-flow
}

# Skip paths
agent -> phase2.describe_tool: "known tool" {
  class: skip-flow
}
agent -> phase3.run_tool: "cached schema" {
  class: skip-flow
}

# Phase progression
phase1 -> phase2: "need schema?" {
  class: phase-flow
}
phase2 -> phase3: "ready to call" {
  class: phase-flow
}
