# PRD-113: Release Automation

**Phase:** 1 - Infrastructure Setup
**Priority:** High
**Effort:** 2 hours
**Dependencies:** PRD-110, PRD-111

---

## Objective

Configure release-please for automated semantic versioning and changelog generation across all consolidated repositories.

---

## Deliverables

| Deliverable | Location | Description |
|-------------|----------|-------------|
| Release Config | `release-please-config.json` | Per-repo release configuration |
| Manifest | `.release-please-manifest.json` | Version tracking |
| Changelog Sections | Configured | Categorized changelog entries |

---

## Tasks

### Task 1: Create Release Configuration Template

**File:** `release-please-config.json` (template for all repos)

```json
{
  "$schema": "https://raw.githubusercontent.com/googleapis/release-please/main/schemas/config.json",
  "release-type": "go",
  "packages": {
    ".": {
      "component": "REPO_NAME",
      "changelog-path": "CHANGELOG.md"
    }
  },
  "changelog-sections": [
    {"type": "feat", "section": "Features", "hidden": false},
    {"type": "fix", "section": "Bug Fixes", "hidden": false},
    {"type": "perf", "section": "Performance Improvements", "hidden": false},
    {"type": "refactor", "section": "Code Refactoring", "hidden": false},
    {"type": "docs", "section": "Documentation", "hidden": false},
    {"type": "test", "section": "Tests", "hidden": true},
    {"type": "chore", "section": "Miscellaneous", "hidden": true},
    {"type": "ci", "section": "Continuous Integration", "hidden": true},
    {"type": "build", "section": "Build System", "hidden": true}
  ],
  "bump-minor-pre-major": true,
  "bump-patch-for-minor-pre-major": true,
  "draft": false,
  "prerelease": false,
  "include-component-in-tag": false,
  "include-v-in-tag": true,
  "pull-request-title-pattern": "chore(release): ${version}",
  "pull-request-header": "## Release PR\n\nThis PR was generated by release-please.",
  "separate-pull-requests": false,
  "sequential-calls": false,
  "group-pull-request-title-pattern": "chore(release): ${version}",
  "release-search-depth": 500,
  "commit-search-depth": 500
}
```

### Task 2: Create Manifest Template

**File:** `.release-please-manifest.json` (template)

```json
{
  ".": "0.0.0"
}
```

### Task 3: Deploy to All Repositories

**Script:** `scripts/deploy-release-config.sh`

```bash
#!/bin/bash
set -euo pipefail

REPOS=(
  toolfoundation
  tooldiscovery
  toolexec
  toolcompose
  toolops
  toolprotocol
)

BASE_DIR=$(pwd)

for repo in "${REPOS[@]}"; do
  REPO_DIR="../$repo"

  if [ ! -d "$REPO_DIR" ]; then
    echo "⚠ $repo directory not found, skipping..."
    continue
  fi

  echo "Configuring release-please for $repo..."

  cd "$REPO_DIR"

  # Create release-please-config.json with repo-specific component name
  cat > release-please-config.json << EOF
{
  "\$schema": "https://raw.githubusercontent.com/googleapis/release-please/main/schemas/config.json",
  "release-type": "go",
  "packages": {
    ".": {
      "component": "$repo",
      "changelog-path": "CHANGELOG.md"
    }
  },
  "changelog-sections": [
    {"type": "feat", "section": "Features", "hidden": false},
    {"type": "fix", "section": "Bug Fixes", "hidden": false},
    {"type": "perf", "section": "Performance Improvements", "hidden": false},
    {"type": "refactor", "section": "Code Refactoring", "hidden": false},
    {"type": "docs", "section": "Documentation", "hidden": false},
    {"type": "test", "section": "Tests", "hidden": true},
    {"type": "chore", "section": "Miscellaneous", "hidden": true},
    {"type": "ci", "section": "Continuous Integration", "hidden": true},
    {"type": "build", "section": "Build System", "hidden": true}
  ],
  "bump-minor-pre-major": true,
  "bump-patch-for-minor-pre-major": true,
  "draft": false,
  "prerelease": false,
  "include-component-in-tag": false,
  "include-v-in-tag": true,
  "pull-request-title-pattern": "chore(release): \${version}",
  "separate-pull-requests": false
}
EOF

  # Create manifest
  echo '{".":" 0.0.0"}' > .release-please-manifest.json

  # Commit if there are changes
  if [ -n "$(git status --porcelain)" ]; then
    git add release-please-config.json .release-please-manifest.json
    git commit -m "chore: configure release-please

- Add release-please-config.json
- Add .release-please-manifest.json
- Configure changelog sections

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
    git push origin main
    echo "✓ $repo configured and pushed"
  else
    echo "✓ $repo already configured"
  fi

  cd "$BASE_DIR"
done

echo ""
echo "All repositories configured!"
echo ""
echo "Release-please will create PRs on next push to main with conventional commits."
```

### Task 4: Verify Release Workflow

After pushing changes, verify the release-please workflow runs:

```bash
for repo in toolfoundation tooldiscovery toolexec toolcompose toolops toolprotocol; do
  echo "=== ApertureStack/$repo ==="
  gh run list -R "ApertureStack/$repo" --workflow="Release Please" --limit 1
  echo ""
done
```

### Task 5: Test Release Flow

Create a test commit to verify the release process:

```bash
cd ../toolfoundation

# Create a feature commit (this will trigger a minor version bump)
echo "// test" >> model/doc.go
git add model/doc.go
git commit -m "feat: add initial model package

This commit sets up the foundation model package structure.

- Add doc.go with package documentation
- Prepare for tool schema types

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"

git push origin main

# Check for release PR
sleep 30  # Wait for workflow to run
gh pr list -R "ApertureStack/toolfoundation" --label "autorelease: pending"
```

### Task 6: Document Release Process

**File:** `docs/RELEASE-PROCESS.md`

```markdown
# Release Process

## Overview

All ApertureStack repositories use [Release Please](https://github.com/googleapis/release-please) for automated releases.

## How It Works

1. **Commit with Conventional Commits**
   ```bash
   git commit -m "feat: add new feature"
   git commit -m "fix: resolve bug"
   git commit -m "docs: update readme"
   ```

2. **Push to Main**
   ```bash
   git push origin main
   ```

3. **Release PR Created**
   - Release Please analyzes commits
   - Creates/updates a release PR
   - Generates CHANGELOG.md entries

4. **Merge Release PR**
   - Review the generated changelog
   - Merge the PR
   - Tag is created automatically
   - GitHub Release is published

## Version Bumping

| Commit Type | Version Bump |
|-------------|--------------|
| `feat:` | Minor (0.1.0 → 0.2.0) |
| `fix:` | Patch (0.1.0 → 0.1.1) |
| `feat!:` or `BREAKING CHANGE:` | Major (0.1.0 → 1.0.0) |
| `docs:`, `chore:`, `ci:` | No bump |

## Breaking Changes

Include `BREAKING CHANGE:` in the commit body:

```bash
git commit -m "feat: change API

BREAKING CHANGE: This changes the public API signature"
```

Or use `!` after the type:

```bash
git commit -m "feat!: change API signature"
```

## Manual Release

If needed, you can create a release manually:

```bash
# Create tag
git tag v1.0.0
git push origin v1.0.0

# Create GitHub release
gh release create v1.0.0 --generate-notes
```

## Troubleshooting

### Release PR not created

1. Check workflow ran: `gh run list --workflow="Release Please"`
2. Verify conventional commits: `git log --oneline -5`
3. Check manifest: `cat .release-please-manifest.json`

### Wrong version

Edit `.release-please-manifest.json` to set the correct version.
```

---

## Verification Checklist

- [ ] `release-please-config.json` in all repos
- [ ] `.release-please-manifest.json` in all repos
- [ ] Release Please workflow exists in all repos
- [ ] Changelog sections configured correctly
- [ ] Test commit triggers release PR
- [ ] Documentation created

---

## Acceptance Criteria

1. Conventional commits trigger release PRs
2. Changelog is generated with correct sections
3. Version bumping follows semver
4. Tags include `v` prefix (e.g., `v1.0.0`)
5. Go module versioning works correctly

---

## Rollback Plan

```bash
# Remove release-please config
for repo in toolfoundation tooldiscovery toolexec toolcompose toolops toolprotocol; do
  cd ../$repo
  rm -f release-please-config.json .release-please-manifest.json
  git add -A
  git commit -m "chore: remove release-please config"
  git push origin main
  cd -
done

# Delete release workflow
for repo in toolfoundation tooldiscovery toolexec toolcompose toolops toolprotocol; do
  rm ../$repo/.github/workflows/release-please.yml
done
```

---

## Next Steps

- PRD-120: Migrate toolmodel (first actual code migration)
- Gate G1: Verify all infrastructure is working
